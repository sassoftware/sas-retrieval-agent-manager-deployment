# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test sas retrieval agent manager app deployment
templates:
  - templates/ui/deployment.yaml
tests:
  - it: should create deployment with correct kind
    asserts:
      - isKind:
          of: Deployment
      - hasDocuments:
          count: 1

  - it: should use correct deployment name
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-app

  - it: should configure replica count
    set:
      sas-retrieval-agent-manager-app:
        replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should not set replicas when autoscaling enabled
    set:
      sas-retrieval-agent-manager-app:
        autoscaling:
          enabled: true
    asserts:
      - notExists:
          path: spec.replicas

  - it: should use correct container image
    set:
      sas-retrieval-agent-manager-app:
        image:
          tag: "latest"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-retrieval-agent-manager-app:latest"

  - it: should configure container ports
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http

  - it: should include security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 10001
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 10001
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 10001

  - it: should include container security context
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true

  - it: should configure resource limits
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi

  - it: should configure resource requests
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 50m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi

  - it: should configure custom resources
    set:
      sas-retrieval-agent-manager-app:
        resources:
          limits:
            cpu: 2
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 1Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 512Mi

  - it: should configure liveness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /SASRetrievalAgentManager/health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 15

  - it: should configure readiness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /SASRetrievalAgentManager/health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 15

  - it: should use correct service account
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: sas-retrieval-agent-manager-app

  - it: should configure image pull secrets
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: cr-sas-secret

  - it: should include workload labels
    asserts:
      - equal:
          path: spec.template.metadata.labels["sas.com/deployment"]
          value: sas-retrieval-agent-manager
      - equal:
          path: spec.template.metadata.labels["workload.sas.com/class"]
          value: ram

  - it: should include volume mounts
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            mountPath: /var/cache/nginx
            name: cache
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            mountPath: /var/run
            name: run
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            mountPath: /home/sas/.promptfoo
            name: promptfoo

  - it: should include volumes
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cache
            emptyDir: {}
      - contains:
          path: spec.template.spec.volumes
          content:
            name: run
            emptyDir: {}
      - contains:
          path: spec.template.spec.volumes
          content:
            name: promptfoo
            emptyDir: {}

  - it: should allow custom affinity configuration
    set:
      sas-retrieval-agent-manager-app:
        affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 1
                preference:
                  matchExpressions:
                    - key: sas.com/deployment
                      operator: In
                      values:
                        - sas-retrieval-agent-manager
    asserts:
      - exists:
          path: spec.template.spec.affinity.nodeAffinity
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].weight
          value: 1
