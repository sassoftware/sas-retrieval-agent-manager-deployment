# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test sas retrieval agent manager app ingress
templates:
  - templates/ui/ingress.yaml
tests:
  - it: should create ingress with correct kind
    asserts:
      - isKind:
          of: Ingress
      - hasDocuments:
          count: 1

  - it: should use correct ingress name
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-app

  - it: should include proper labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: sas-retrieval-agent-manager-1.2.3-dev.20241225

  - it: should configure ingress class
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should include required annotations
    asserts:
      - equal:
          path: metadata.annotations["kubernetes.io/ingress.allow-http"]
          value: "false"
      - equal:
          path: metadata.annotations["kubernetes.io/tls-acme"]
          value: "true"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"

  - it: should include oauth annotations
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: "Authorization"
      # - matchRegex:
      #     path: metadata.annotations["nginx.ingress.kubernetes.io/auth-signin"]
      #     pattern: "/SASRetrievalAgentManager/oauth2/start"
      # - matchRegex:
      #     path: metadata.annotations["nginx.ingress.kubernetes.io/auth-url"]
      #     pattern: "/SASRetrievalAgentManager/oauth2/auth"

  - it: should include nginx specific annotations
    set:
      global:
        configuration:
          ui:
            enableRootIngress: true
        ingress:
          enabled: false
      sas-retrieval-agent-manager-app:
        ingress:
          hosts:
            - host: chart-example.local
              paths:
                - path: /SASRetrievalAgentManager(/|$)(.*)
                  pathType: ImplementationSpecific
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/app-root"]
          value: "/SASRetrievalAgentManager"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/proxy-body-size"]
          value: "500m"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/proxy-buffer-size"]
          value: "16k"

  # - it: should configure TLS section
  #   asserts:
  #     - exists:
  #         path: spec.tls
  #     - exists:
  #         path: spec.tls[0].hosts

  - it: should configure ingress rules
    set:
      global:
        ingress:
          enabled: false
      sas-retrieval-agent-manager-app:
        ingress:
          hosts:
            - host: chart-example.local
              paths:
                - path: /SASRetrievalAgentManager(/|$)(.*)
                  pathType: ImplementationSpecific
    asserts:
      - exists:
          path: spec.rules
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: "/SASRetrievalAgentManager(/|$)(.*)"
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: "ImplementationSpecific"

  - it: should configure backend service
    set:
      global:
        ingress:
          enabled: false
      sas-retrieval-agent-manager-app:
        ingress:
          hosts:
            - host: chart-example.local
              paths:
                - path: /SASRetrievalAgentManager(/|$)(.*)
                  pathType: ImplementationSpecific
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: sas-retrieval-agent-manager-app
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 8080

  - it: should not create ingress when disabled
    set:
      sas-retrieval-agent-manager-app:
        ingress:
          enabled: false
      global:
        ingress:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom ingress class
    set:
      sas-retrieval-agent-manager-app:
        ingress:
          className: "custom-class"
      global:
        ingress:
          enabled: false
    asserts:
      - equal:
          path: spec.ingressClassName
          value: "custom-class"
