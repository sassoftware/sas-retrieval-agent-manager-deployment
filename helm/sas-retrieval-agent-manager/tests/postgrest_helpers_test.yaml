# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test postgrest helper functions
templates:
  - templates/db/rest/deployment.yaml
tests:
  - it: should use default postgrest name
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-postgrest

  - it: should use custom nameOverride with default fullname
    set:
      postgrest:
        nameOverride: "custom-name"
        fullnameOverride: ""
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-postgrest

  - it: should use custom fullnameOverride
    set:
      postgrest:
        fullnameOverride: "custom-full-name"
    asserts:
      - equal:
          path: metadata.name
          value: custom-full-name

  - it: should handle release name containing chart name
    release:
      name: "postgrest-production"
    set:
      postgrest:
        nameOverride: "postgrest"
        fullnameOverride: ""
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-postgrest

  - it: should include proper labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: postgrest
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should handle global image registry
    set:
      global:
        image:
          repo:
            base: "global.registry.io"
      postgrest:
        image:
          postgrest:
            tag: "latest"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "global.registry.io/postgrest/postgrest:latest"

  - it: should use local image when global not available
    set:
      global: {}
      postgrest:
        image:
          postgrest:
            repo:
              base: "local.registry.io"
            tag: "latest"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "local.registry.io/postgrest/postgrest:latest"

  - it: should use custom image tag
    set:
      postgrest:
        image:
          postgrest:
            tag: "v13.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "docker.io/postgrest/postgrest:v13.0.0"

  - it: should use custom image pull policy
    set:
      postgrest:
        image:
          postgrest:
            pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
