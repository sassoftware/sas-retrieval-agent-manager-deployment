# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test keycloak secrets
templates:
  - templates/iam/keycloak/keycloak-admin-secret.yaml
  - templates/iam/keycloak/keycloak-appadmin-secret.yaml
  - templates/iam/keycloak/oauth2-proxy-client-secret.yaml
  - templates/iam/keycloak/realm-secret.yaml
tests:
  - it: should create keycloak admin secret
    template: templates/iam/keycloak/keycloak-admin-secret.yaml
    set:
      global:
        configuration:
          keycloak:
            keycloakAdmin: "admin"
            keycloakAdminPassword: "admin123"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: keycloak-admin-secret
      - equal:
          path: type
          value: Opaque
      - equal:
          path: stringData.user
          value: "admin"
      - equal:
          path: stringData.password
          value: "admin123"

  - it: should include proper labels on admin secret
    template: templates/iam/keycloak/keycloak-admin-secret.yaml
    set:
      global:
        configuration:
          keycloak:
            keycloakAdmin: "admin"
            keycloakAdminPassword: "admin123"
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: keycloak
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: sas-retrieval-agent-manager-1.2.3-dev.20241225

  - it: should create keycloak appadmin secret
    template: templates/iam/keycloak/keycloak-appadmin-secret.yaml
    set:
      global:
        configuration:
          keycloak:
            appAdmin: "appadmin"
            appAdminPassword: "appadmin123"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: keycloak-appadmin-secret
      - equal:
          path: stringData.user
          value: "appadmin"
      - equal:
          path: stringData.password
          value: "appadmin123"

  - it: should create oauth proxy client secret with default config
    template: templates/iam/keycloak/oauth2-proxy-client-secret.yaml
    set:
      keycloak:
        service:
          port: 8080
        fullnameOverride: ""
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: keycloak-client-secret
      - equal:
          path: stringData.url
          value: "http://sas-retrieval-agent-manager-keycloak:8080"

  - it: should create oauth proxy client secret with custom service port
    template: templates/iam/keycloak/oauth2-proxy-client-secret.yaml
    set:
      keycloak:
        service:
          port: 9090
        fullnameOverride: ""
    asserts:
      - equal:
          path: stringData.url
          value: "http://sas-retrieval-agent-manager-keycloak:9090"

  - it: should create oauth proxy client secret with fullnameOverride
    template: templates/iam/keycloak/oauth2-proxy-client-secret.yaml
    set:
      keycloak:
        fullnameOverride: "custom-keycloak"
        service:
          port: 8080
    asserts:
      - equal:
          path: stringData.url
          value: "http://custom-keycloak:8080"

  # TODO: Global/service at root level not supported in parent chart structure\n  # - it: should create oauth proxy client secret with global ingress enabled\n  #   template: templates/iam/keycloak/oauth2-proxy-client-secret.yaml\n  #   set:\n  #     global:\n  #       ingress:\n  #         enabled: true\n  #     service:\n  #       port: 8080\n  #     fullnameOverride: \"\"\n  #   asserts:\n  #     - hasDocuments:\n  #         count: 1\n  #     - equal:\n  #         path: stringData.url\n  #         value: \"http://RELEASE-NAME-keycloak:8080\"

  - it: should create realm secret
    template: templates/iam/keycloak/realm-secret.yaml
    set:
      global:
        configuration:
          keycloak:
            realm: "test-realm"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: keycloak-realm-secret

  - it: should handle missing global configuration gracefully
    template: templates/iam/keycloak/keycloak-admin-secret.yaml
    set:
      global:
        configuration:
          keycloak:
            keycloakAdmin: ""
            keycloakAdminPassword: ""
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: stringData.user
          value: ""
      - equal:
          path: stringData.password
          value: ""

  - it: should work with different release names
    template: templates/iam/keycloak/oauth2-proxy-client-secret.yaml
    release:
      name: custom-release
    set:
      keycloak:
        service:
          port: 8080
        fullnameOverride: ""
    asserts:
      - equal:
          path: stringData.url
          value: "http://sas-retrieval-agent-manager-keycloak:8080"