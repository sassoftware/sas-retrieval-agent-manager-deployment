# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test sas retrieval agent manager db init secrets
templates:
  - templates/db/init/db-admin-secret.yaml
  - templates/db/init/db-application-secret.yaml
  - templates/db/init/db-keycloak-secret.yaml
  - templates/db/init/db-migration-secret.yaml
  - templates/db/init/db-vector-store-secret.yaml
  - templates/db/init/db-vectorization-job-secret.yaml
tests:
  - it: should create admin secret with correct properties
    template: templates/db/init/db-admin-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: admin-db-credentials
      - equal:
          path: stringData.user
          value: "azure_pg_admin"
      - exists:
          path: stringData.password
      - equal:
          path: metadata.annotations["argocd.argoproj.io/compare-options"]
          value: "IgnoreExtraneous"

  - it: should create application secret with correct properties
    template: templates/db/init/db-application-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: application-db-credentials
      - equal:
          path: stringData.user
          value: "sas_ram_pgrest_user"
      - exists:
          path: stringData.password

  - it: should create keycloak secret with correct properties
    template: templates/db/init/db-keycloak-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: keycloak-db-credentials
      - equal:
          path: stringData.user
          value: "sas_keycloak_user"
      - exists:
          path: stringData.password

  - it: should create migration secret with correct properties
    template: templates/db/init/db-migration-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: migration-db-credentials
      - equal:
          path: stringData.user
          value: "sas_iot_migration"
      - exists:
          path: stringData.password

  - it: should create vector store secret with correct properties
    template: templates/db/init/db-vector-store-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: vector-store-db-credentials
      - equal:
          path: stringData.user
          value: "vector_store_user"
      - exists:
          path: stringData.password

  - it: should create vectorization job secret with correct properties
    template: templates/db/init/db-vectorization-job-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: vectorization-job-db-credentials
      - equal:
          path: stringData.user
          value: "sas_ram_vectorization_user"
      - exists:
          path: stringData.password

  - it: should include proper labels on all secrets
    template: templates/db/init/db-admin-secret.yaml
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: sas-retrieval-agent-manager-db-init
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: sas-retrieval-agent-manager-1.2.3-dev.20241225

  - it: should support custom admin password
    set:
      global:
        configuration:
          database:
            initAdminPassword: "custom_admin_password"
    template: templates/db/init/db-admin-secret.yaml
    asserts:
      - equal:
          path: stringData.password
          value: "custom_admin_password"

  - it: should support custom admin role
    set:
      global:
        configuration:
          database:
            initAdminRole: "custom_admin_user"
    template: templates/db/init/db-admin-secret.yaml
    asserts:
      - equal:
          path: stringData.user
          value: "custom_admin_user"

  - it: should support custom migration password
    set:
      global:
        configuration:
          migration:
            dbMigrationPassword: "custom_migration_password"
    template: templates/db/init/db-migration-secret.yaml
    asserts:
      - equal:
          path: stringData.password
          value: "custom_migration_password"
