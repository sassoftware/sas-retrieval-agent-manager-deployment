# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test keycloak oauth proxy components
templates:
  - templates/iam/oauth2-proxy/deployment.yaml
  - templates/iam/oauth2-proxy/service.yaml
  - templates/iam/oauth2-proxy/serviceaccount.yaml
  - templates/iam/oauth2-proxy/configmap.yaml
  - templates/iam/oauth2-proxy/oauth-configmap.yaml
  - templates/iam/oauth2-proxy/oauth2-cookie-secret.yaml
  - templates/iam/oauth2-proxy/ingress.yaml
  - templates/iam/oauth2-proxy/route.yaml
  - templates/iam/oauth2-proxy/logout-ingress.yaml
  - templates/iam/oauth2-proxy/logout-route.yaml
tests:
  - it: should create oauth proxy deployment
    template: templates/iam/oauth2-proxy/deployment.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-oauth2-proxy

  - it: should create oauth proxy service
    template: templates/iam/oauth2-proxy/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-oauth2-proxy

  - it: should create oauth proxy service account
    template: templates/iam/oauth2-proxy/serviceaccount.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: oauth2-proxy

  - it: should create oauth proxy configmap
    template: templates/iam/oauth2-proxy/configmap.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - exists:
          path: data

  - it: should create oauth configmap
    template: templates/iam/oauth2-proxy/oauth-configmap.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - exists:
          path: data

  - it: should create oauth2 cookie secret
    template: templates/iam/oauth2-proxy/oauth2-cookie-secret.yaml
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: stringData

  - it: should use custom fullnameOverride for oauth proxy
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      keycloak:
        oauthProxy:
          fullnameOverride: "custom-oauth-proxy"
    asserts:
      - equal:
          path: metadata.name
          value: custom-oauth-proxy

  - it: should use custom nameOverride for oauth proxy
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      keycloak:
        oauthProxy:
          fullnameOverride: "custom-name"
    asserts:
      - equal:
          path: metadata.name
          value: custom-name

  - it: should configure oauth proxy replicas
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      keycloak:
        oauthProxy:
          replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use global image registry for oauth proxy
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      global:
        image:
          repo:
            base: "global.registry.io"
      keycloak:
        oauthProxy:
          image:
            tag: "latest"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "global.registry.io/oauth2-proxy/oauth2-proxy:latest"

  - it: should use local image registry when global not available
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      global: {}
      keycloak:
        oauthProxy:
          image:
            repo:
              base: "local.registry.io"
            tag: "latest"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "local.registry.io/oauth2-proxy/oauth2-proxy:latest"

  - it: should create ingress when global ingress enabled
    template: templates/iam/oauth2-proxy/ingress.yaml
    set:
      global:
        ingress:
          enabled: true
      keycloak:
        oauthProxy:
          ingress:
            enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Ingress

  - it: should not create ingress when global ingress disabled
    template: templates/iam/oauth2-proxy/ingress.yaml
    set:
      global:
        ingress:
          enabled: false
      keycloak:
        oauthProxy:
          ingress:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  # - it: should create route when className is route
  #   template: templates/iam/oauth2-proxy/route.yaml
  #   set:
  #     keycloak:
  #       oauthProxy:
  #         ingress:
  #           enabled: true
  #           className: "route"
  #   asserts:
  #     - hasDocuments:
  #         count: 1
  #     - isKind:
  #         of: Route

  - it: should not create route when className is not route
    template: templates/iam/oauth2-proxy/route.yaml
    set:
      keycloak:
        oauthProxy:
          ingress:
            enabled: true
            className: "nginx"
    asserts:
      - hasDocuments:
          count: 0

  - it: should configure oauth proxy service type
    template: templates/iam/oauth2-proxy/service.yaml
    set:
      keycloak:
        oauthProxy:
          service:
            type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should configure oauth proxy service port
    template: templates/iam/oauth2-proxy/service.yaml
    set:
      keycloak:
        oauthProxy:
          service:
            port: 8080
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 8080

  - it: should handle autoscaling disabled in oauth proxy
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      keycloak:
        oauthProxy:
          autoscaling:
            enabled: false
          replicaCount: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should remove replicas when autoscaling enabled
    template: templates/iam/oauth2-proxy/deployment.yaml
    set:
      keycloak:
        oauthProxy:
          autoscaling:
            enabled: true
    asserts:
      - notExists:
          path: spec.replicas