# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test sas retrieval agent manager app helper functions
templates:
  - templates/ui/deployment.yaml
tests:
  - it: should use default app name
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-app

  - it: should use custom nameOverride with default fullname
    set:
      sas-retrieval-agent-manager-app:
        nameOverride: "custom-name"
        fullnameOverride: ""
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-app
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: custom-name

  - it: should use custom fullnameOverride
    set:
      sas-retrieval-agent-manager-app:
        fullnameOverride: "custom-full-name"
    asserts:
      - equal:
          path: metadata.name
          value: custom-full-name

  - it: should handle release name containing chart name
    release:
      name: "app-production"
    set:
      sas-retrieval-agent-manager-app:
        nameOverride: "app"
        fullnameOverride: ""
    asserts:
      - equal:
          path: metadata.name
          value: sas-retrieval-agent-manager-app
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: app

  - it: should include proper labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: sas-retrieval-agent-manager-1.2.3-dev.20241225

  - it: should handle global image registry
    set:
      sas-retrieval-agent-manager-app:
        image:
          tag: "latest"
      global:
        image:
          repo:
            base: "global.registry.io"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "global.registry.io/viya-4-x64_oci_linux_2-docker/sas-retrieval-agent-manager-app:latest"

  - it: should use local image when global not available
    set:
      sas-retrieval-agent-manager-app:
        image:
          tag: "latest"
      global: {}
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-retrieval-agent-manager-app:latest"

  - it: should use custom image tag
    set:
      sas-retrieval-agent-manager-app:
        image:
          tag: "2.0.0-test"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-retrieval-agent-manager-app:2.0.0-test"

  - it: should use custom image pull policy
    set:
      sas-retrieval-agent-manager-app:
        image:
          pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

