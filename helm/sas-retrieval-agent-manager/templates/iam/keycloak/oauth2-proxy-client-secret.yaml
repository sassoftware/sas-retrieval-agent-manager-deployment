{{- $dot := . -}}
{{- $globalEnabled := false -}}
{{- if hasKey .Values "global" -}}
{{- if hasKey .Values.global "ingress" -}}
{{- if .Values.global.ingress.enabled -}}
{{- $globalEnabled = .Values.global.ingress.enabled -}}
{{- end -}}
{{- end -}}
{{- end -}}
---
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-client-secret
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
type: Opaque
stringData:
  url: "http://{{ include "keycloak.fullname" . }}:{{ .Values.keycloak.service.port }}"
  oauthUrl: {{ if $globalEnabled -}}
          "https://{{ .Values.global.domain }}{{ regexReplaceAll "\\(.*" (first .Values.keycloak.oauthProxy.ingress.paths).path "" }}"
       {{- else -}}
          "https://{{ with (first .Values.keycloak.oauthProxy.ingress.hosts) }}{{ .host }}/{{ with (first .paths) }}{{ regexReplaceAll "\\(.*" .path "" }}{{ end }}{{ end }}"
       {{- end }}
  realm: {{ .Values.global.configuration.keycloak.realm | quote }}
  sv-client-id: {{ .Values.global.configuration.keycloak.clientId | quote }}
  sv-client-secret: {{ include "keycloak.clientSecret" . | quote }}